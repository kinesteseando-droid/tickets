<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Tickets + Eventos (Admin Kinesteseando)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    .admin-panel{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .event-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .user-card{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
    .scanner-panel{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50}
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="container mx-auto p-4">
  <!-- Header -->
  <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">🎫 Kinesteseando Tickets - Panel Admin</h1>
    <p class="text-gray-600">Sistema conectado a Google Sheets</p>
  </div>

  <!-- Nav -->
  <div class="flex flex-wrap justify-center gap-4 mb-8">
    <button onclick="showPanel('admin')" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold">👑 Administración</button>
    <button onclick="showPanel('events')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold">📅 Eventos</button>
    <button onclick="showPanel('users')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">👥 Usuarios</button>
    <button onclick="showPanel('scanner')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">📱 Scanner</button>
  </div>

  <!-- Admin -->
  <div id="adminPanel" class="admin-panel rounded-xl p-6 text-white mb-8">
    <h2 class="text-2xl font-bold mb-6">👑 Panel de Administración</h2>
    <div class="bg-white/10 rounded-lg p-4 space-y-6">
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Spreadsheet ID</label>
          <input id="sheetId" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70"
            value="1tYsZfPdH9X3uykaap3WKj15xMxS6bGk2saI2Wsgc3fc" readonly />
        </div>
        <div>
          <label class="block text-sm mb-1">API Key</label>
          <input id="apiKey" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70"
            value="AIzaSyBqJ8K9L3mN4oP5qR6sT7uV8wX9yZ0A1B2C" readonly />
        </div>
      </div>
      <div>
        <label class="block text-sm mb-1">🌐 Proxy URL (Apps Script)</label>
        <input id="proxyUrl" class="w-full p-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70"
          value="https://script.google.com/macros/s/AKfycbwsBh0CrIhs0d97QHDIM0-6TxFEaUYGU5ysG9Q9_7ZXpeFz30M-XMcNguhZLbwO4u-XJg/exec" readonly />
      </div>
      <div class="flex gap-4">
        <button onclick="testConnection()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">🔍 Probar</button>
        <button onclick="initSheets()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-semibold">🚀 Inicializar</button>
      </div>
      <div id="configStatus" class="mt-4 p-3 rounded-lg bg-white/10"></div>
    </div>
  </div>

  <!-- Eventos -->
  <div id="eventsPanel" class="rounded-xl p-6 shadow mb-8 bg-white" style="display:none">
    <h2 class="text-2xl font-bold mb-6 text-indigo-700">📅 Eventos</h2>
    <div id="eventList"></div>
  </div>

  <!-- Usuarios -->
  <div id="usersPanel" class="rounded-xl p-6 shadow mb-8 bg-white" style="display:none">
    <h2 class="text-2xl font-bold mb-6 text-blue-700">👥 Usuarios</h2>
    <div id="userList"></div>
  </div>

  <!-- Scanner -->
  <div id="scannerPanel" class="rounded-xl p-6 shadow mb-8 bg-white" style="display:none">
    <h2 class="text-2xl font-bold mb-6 text-green-700">📱 Validación de Tickets</h2>
    <input id="ticketCodeInput" type="text" class="border p-2 rounded-lg w-full mb-4" placeholder="Pega o escribe el código del ticket..." />
    <button onclick="validateTicket()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold">Validar</button>
    <div id="scannerResult" class="mt-4"></div>
  </div>
</div>

<script>
// --- Configuración fija ---
const SHEET_ID = "1tYsZfPdH9X3uykaap3WKj15xMxS6bGk2saI2Wsgc3fc";
const API_KEY = "AIzaSyBqJ8K9L3mN4oP5qR6sT7uV8wX9yZ0A1B2C";
const PROXY_URL = "https://script.google.com/macros/s/AKfycbwsBh0CrIhs0d97QHDIM0-6TxFEaUYGU5ysG9Q9_7ZXpeFz30M-XMcNguhZLbwO4u-XJg/exec";

// Helpers UI
function showPanel(panel) {
  document.getElementById("adminPanel").style.display = (panel === 'admin') ? '' : 'none';
  document.getElementById("eventsPanel").style.display = (panel === 'events') ? '' : 'none';
  document.getElementById("usersPanel").style.display = (panel === 'users') ? '' : 'none';
  document.getElementById("scannerPanel").style.display = (panel === 'scanner') ? '' : 'none';
}

// --- Prueba de conexión ---
function testConnection() {
  const configStatus = document.getElementById("configStatus");
  configStatus.innerHTML = "🔄 Probando conexión...";
  fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${API_KEY}`)
    .then(r => r.ok ? r.json() : Promise.reject("No se pudo acceder a Sheets"))
    .then(data => configStatus.innerHTML = "✅ Google Sheets accesible")
    .catch(err => configStatus.innerHTML = "❌ Error: " + err);
}

// --- Inicializar hojas (opcional) ---
function initSheets() {
  const configStatus = document.getElementById("configStatus");
  configStatus.innerHTML = "🔄 Inicializando hojas...";
  fetch(PROXY_URL, {
    method: "POST",
    body: JSON.stringify({action: "initSheets"}),
    headers: {"Content-Type": "application/json"}
  })
  .then(r => r.json())
  .then(data => {
    if(data.ok) configStatus.innerHTML = "✅ Hojas listas";
    else configStatus.innerHTML = "❌ Error: " + (data.error || "No se pudo inicializar");
  })
  .catch(err => configStatus.innerHTML = "❌ Error: " + err);
}

// --- CRUD Eventos / Usuarios ---
async function fetchEvents() {
  // Lee la hoja "Eventos"
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Eventos?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  renderEventList(data.values || []);
}
function renderEventList(rows) {
  const el = document.getElementById("eventList");
  if(!rows || rows.length < 2) { el.innerHTML = "Sin eventos."; return; }
  let html = `<table class="min-w-full border mb-4"><thead><tr>${
    rows[0].map(h=>`<th class="border p-2">${h}</th>`).join('')
  }</tr></thead><tbody>${
    rows.slice(1).map(row=>`<tr>${row.map(v=>`<td class="border p-2">${v}</td>`).join('')}</tr>`).join('')
  }</tbody></table>`;
  el.innerHTML = html + `<button onclick="fetchEvents()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg">🔄 Recargar</button>`;
}
async function fetchUsers() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Usuarios?key=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  renderUserList(data.values || []);
}
function renderUserList(rows) {
  const el = document.getElementById("userList");
  if(!rows || rows.length < 2) { el.innerHTML = "Sin usuarios."; return; }
  let html = `<table class="min-w-full border mb-4"><thead><tr>${
    rows[0].map(h=>`<th class="border p-2">${h}</th>`).join('')
  }</tr></thead><tbody>${
    rows.slice(1).map(row=>`<tr>${row.map(v=>`<td class="border p-2">${v}</td>`).join('')}</tr>`).join('')
  }</tbody></table>`;
  el.innerHTML = html + `<button onclick="fetchUsers()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">🔄 Recargar</button>`;
}

// --- Validación de ticket (búsqueda y marcado) ---
async function validateTicket() {
  const code = document.getElementById('ticketCodeInput').value.trim();
  const el = document.getElementById('scannerResult');
  if(!code) { el.innerHTML = "Ingresa o pega un código de ticket."; return; }
  el.innerHTML = "🔄 Validando ticket...";
  // Busca en la hoja "Tickets"
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Tickets?key=${API_KEY}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    const rows = data.values || [];
    const idx = rows.findIndex(r => r[0] === code);
    if(idx === -1) { el.innerHTML = "❌ Ticket no encontrado."; return; }
    const ticket = rows[idx];
    if(ticket[3] === "usado") { el.innerHTML = "⚠️ Ticket ya usado."; return;}
    // Marca como usado
    const now = new Date().toISOString();
    await fetch(PROXY_URL, {
      method: "POST",
      body: JSON.stringify({
        action: "validateTicket",
        code, status: "usado", usedAt: now
      }),
      headers: {"Content-Type": "application/json"}
    });
    el.innerHTML = "✅ Ticket validado y marcado como usado.";
  } catch(err) {
    el.innerHTML = "❌ Error: " + err;
  }
}

// --- Inicialización por defecto ---
document.addEventListener("DOMContentLoaded", ()=>{
  showPanel("admin");
  fetchEvents();
  fetchUsers();
});
</script>
</body>
</html>